# BIG-IQ Collector

## Description

The bigIQCollect.sh script must be copied and run on a BIG-IQ Centralized Manager instance. It will collect raw JSON files and package them into a single .tgz file:
the .tgz file can then be processed offline by the Instance Counter to generate the final JSON file

sampledata.tgz is provided for testing purposes

## Usage

- Copy (scp) bigIQCollect.sh from your local host to your BIG-IQ CM instance, under /tmp/

```
$ scp bigIQCollect.sh root@bigiq.f5:/tmp/
(root@bigiq.f5) Password: 
bigIQCollect.sh                              100% 1611   789.7KB/s   00:00    
$ 
```

- SSH to your BIG-IQ CM instance and run the collection script using "admin" as the authentication username and its password

```
$ ssh root@bigiq.f5
(root@bigiq.f5) Password: 
Last login: Fri Nov 19 00:00:05 2021 from 192.168.1.18
[root@bigiq:Active:Standalone] config # . /tmp/bigIQCollect.sh admin the-admin-password
-> Reading device list
-> Reading system provisioning
-> Reading device inventory
-> Reading device inventory details
-> Reading device info for [aabcaca7-6986-4d0b-b9fe-b72e3473144e]
-> Reading device info for [1346a1f5-49aa-422f-8c4d-19b0119b3927]
-> Data collection completed, building tarfile
-> All done, copy /tmp/20211119-0000-bigIQCollect.tgz to your local host using scp
[root@bigiq:Active:Standalone] config # exit
logout
Connection to bigiq.f5 closed.
$ 
```

- Retrieve the tgz file generated by bigIQCollect.sh

```
$ scp root@bigiq.f5:/tmp/20211119-0000-bigIQCollect.tgz .
(root@bigiq.f5) Password: 
20211119-0000-bigIQCollect.tgz               100%   14KB   5.4MB/s   00:00    
$ 
```

- Start the Instance Counter and the additional fileserver script to process the tgz file and generate the target JSON file

```
$ ./nicfsStart.sh 20211119-0000-bigIQCollect.tgz
/tmp/tmp.ekuupTf6nD
Using JSON directory [ /tmp/tmp.ekuupTf6nD ]
 * Serving Flask app 'nicfs' (lazy loading)
 * Environment: production
   WARNING: This is a development server. Do not use it in a production deployment.
   Use a production WSGI server instead.
 * Debug mode: off
 * Running on all addresses.
   WARNING: This is a development server. Do not use it in a production deployment.
 * Running on http://192.168.1.18:5001/ (Press CTRL+C to quit)
Running BIG-IQ inventory refresh thread
2021-11-19 00:03:32.971872 Requesting BIG-IQ inventory refresh
Running REST API/Prometheus metrics server
 * Serving Flask app 'app' (lazy loading)
 * Environment: production
   WARNING: This is a development server. Do not use it in a production deployment.
   Use a production WSGI server instead.
 * Debug mode: off
 * Running on all addresses.
   WARNING: This is a development server. Do not use it in a production deployment.
 * Running on http://192.168.1.18:5000/ (Press CTRL+C to quit)
192.168.1.18 - - [19/Nov/2021 00:03:32] "POST /mgmt/shared/authn/login HTTP/1.1" 200 -
192.168.1.18 - - [19/Nov/2021 00:03:32] "POST /mgmt/cm/device/tasks/device-inventory HTTP/1.1" 405 -
```

- Query the Instance Counter from another terminal session to get the target JSON file

```
$ curl http://127.0.0.1:5000/instances
{ "instances": [{ "bigip":"2","hwTotals":[{"F5-VE": 2}],"swTotals":[{"H-VE-LTM": 2, "H-VE-DNS": 1, "H-VE-AWF": 1, "H-VE-AFM": 1}]}], "details": [{"hostname":"bigip1.f5.ff.lan","address":"192.168.1.69","product":"BIG-IP","version":"16.1.0","edition":"Final","build":"0.0.19","isVirtual":"True","isClustered":"False","platformMarketingName":"BIG-IP Virtual Edition","restFrameworkVersion":"16.1.0-0.0.19","inventoryTimestamp":"1637274003602","inventoryStatus":"full","platform":{"code":"Z100","type":"VE","sku":"F5-VE"},"registrationKey":"XXXXX-XXXXX-XXXXX-XXXXX-XXXXXXX","chassisSerialNumber":"00000000-0000-0000-000000000000","licenseEndDateTime":"2021-11-27T00:00:00+01:00","licensedModules":["adc", "BigIPDevice"],"provisionedModules":[{"module":"afm","level":"none","sku":"H-VE-AFM"},{"module":"dos","level":"","sku":""},{"module":"ltm","level":"nominal","sku":"H-VE-LTM"},{"module":"asm","level":"none","sku":"H-VE-AWF"},{"module":"avr","level":"","sku":""},{"module":"sslo","level":"none","sku":"H-VE-SSLO"},{"module":"ilx","level":"","sku":""},{"module":"cgnat","level":"none","sku":"H-VE-CGNAT"},{"module":"swg","level":"","sku":""},{"module":"gtm","level":"nominal","sku":"H-VE-DNS"},{"module":"lc","level":"","sku":""},{"module":"pem","level":"none","sku":"H-VE-PEM"},{"module":"apm","level":"none","sku":"H-VE-APM"},{"module":"urldb","level":"","sku":""},{"module":"fps","level":"","sku":""}]},{"hostname":"bigip.f5.ff.lan","address":"192.168.1.70","product":"BIG-IP","version":"16.1.0","edition":"Final","build":"0.0.19","isVirtual":"True","isClustered":"False","platformMarketingName":"BIG-IP Virtual Edition","restFrameworkVersion":"16.1.0-0.0.19","inventoryTimestamp":"1637274003602","inventoryStatus":"full","platform":{"code":"Z100","type":"VE","sku":"F5-VE"},"registrationKey":"XXXXX-XXXXX-XXXXX-XXXXX-XXXXXXX","chassisSerialNumber":"00000000-0000-0000-000000000000","licenseEndDateTime":"2021-11-26T00:00:00+01:00","licensedModules":["asmsecurity", "adc", "Access", "dns", "BigIPDevice", "networksecurity", "sharedsecurity"],"provisionedModules":[{"module":"sslo","level":"none","sku":"H-VE-SSLO"},{"module":"gtm","level":"none","sku":"H-VE-DNS"},{"module":"cgnat","level":"none","sku":"H-VE-CGNAT"},{"module":"apm","level":"none","sku":"H-VE-APM"},{"module":"ltm","level":"nominal","sku":"H-VE-LTM"},{"module":"fps","level":"","sku":""},{"module":"avr","level":"","sku":""},{"module":"dos","level":"","sku":""},{"module":"lc","level":"","sku":""},{"module":"pem","level":"none","sku":"H-VE-PEM"},{"module":"urldb","level":"","sku":""},{"module":"swg","level":"","sku":""},{"module":"asm","level":"nominal","sku":"H-VE-AWF"},{"module":"ilx","level":"","sku":""},{"module":"afm","level":"nominal","sku":"H-VE-AFM"}]}]}$ 
```
